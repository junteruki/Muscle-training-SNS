# GCPエンタープライズ設計ガイド

## ・## App Engine
　Blue-Greenデプロイ
　　本番稼動中のアクティブなサーバに手を入れるのではなく、Green環境と呼ばれるもうひとつの環境にサーバを構築し
　　シームレスなサーバの切り替えを実現する方法。
　　そのために一つのWebアプリにバージョン情報をつけて、デプロイする機能がある。
　　
　　App Engineを用いてデプロイしたアプリのURLは
https://プロジェクトID.appspot.com
　　となる。

　　バージョンを指定する際は　
　　https://バージョン-dot-プロジェクトID.appspot.com
　　となる。

　　バージョンの切り替えはApp Engineの管理画面から新しいバージョンを選択し、トラフィックを移行を選択することで実現する。
　　また、IPアドレスやクッキーベースで一定の比率でアクセスを振り分けることができる。
　　→新しいバージョンの様子を見ながら徐々に切り替えることが可能。

　　
　Cronサービスとタスクキュー
　　一日のうちに決められた時間に実行する処理や一定間隔で実行する処理はApp Engine Cron処理が便利
　　HTTP GETリクエストを使用し、Cronジョブに定義されたURLを自動的に呼び出し、実行可能

　　App EngineへのHTTPリクエストとは非同期にバックグラウンドでユーザが定義した処理を行うタスクキューという機能もある。

　アクセス制御
　　ファイアフォールを使用したIPレベルでの制御→対象の攻撃には403エラーを返す。
　　権限の管理→プロジェクトレベルのアクセス制限や、コードのデプロイや閲覧の権限など


　暗号化
　　App EngineのSE版では、コンテナのオートスケールに対応するため、ローカルディスクへの永続データの保存ができない。
　　そのため、通常はCloud StrageやDatastoreが使用される。
　　このとき、格納データはディスクに書き込まれる前に自動的に暗号化されて保存される。

　バックアップ
　　特になし。

・Kubernates Engine
　言わずもがなコンテナを実現するサービス。
　
　バックアップ
　　コンテナを管理するためのマスタサーバやクラスタの構成情報を保持するバックエンドデータベース（etcd）は自動でバックアップが取得される

　拡張性
　　各コンテナに必要なリソースを指定できる。リソースの使用率に応じて自動的にオートスケールする機能が備わっている。

　耐障害性
　　ノードの自動修復設定を有効にしておくことで、ヘルスチェックでノードに異常が見つかった時は
　　修復プロセスが走る。

　
・Cloud Functions
　コードの実行をおこなう、関数で呼び出した時のみプロセスが起動するサービス
　サポート言語はJavascriptのみ
　

◆ストレージサービス
　たくさんのストレージサービスがあるのでその使い分けを考える

・使い分け
　①構造化データ
　　データが構造化されていない画像やテキストファイルなどはCloud Strageとなる。
　　
　②データ解析
　　大容量のデータを保管し、解析用途で利用する場合にはBigTableとcBigQueryが対象となる。
　
　③低レイテンシ
　　Bigtableは同一リージョン内のGCEからは10ミリ秒程度でアクセスが可能。
　　反面複雑なクエリには対応していない。
　　逆にバッチや準オンライン処理の時は、複雑なクエリーも処理でき、使いやすいBigQueryをお勧める。

　④リレーショナルデータベース
　　DataStoreはSQLライクな問い合わせとACIDトランザクションをサポートしている。
　　自動スケールや処理が重くならない、廉価である。RDBでなくても良い場合はDatastoreがおすすめ
　　RDBが必要な場合には、Cloud SQLとSpannerが候補。
　　
　⑤高拡張性
　　Cloud SQLには処理の負荷に応じたオートスケール機能はない。
　　Read性能が不足した場合には、リードレプリカによるスケールアウト、write性能が不足した場合には
　　リソースを拡張するスケールあっぷが必要だ

　　Spannerは大規模かつ水平スケーリングする。がなんか色々癖があるから気をつけろ的なこと書いてた

・Cloud Strage
　画像や動画など静的やGCP上で動作する各種サービスのデータストア、バックアップ、アーカイブの保管

　1オブジェクトの最大サイズは5Tバイトだが、数は無制限なので実質容量無制限
　【オブジェクトの操作】
　　コンソール画面　
　　コマンドライン（gsutil）
　　クライアントライブラリ
　　Rest API経由
　　
　また、オープンソフトのCloud Storage FUSEを利用することでLinxまたはOSXシステム上でファイルシステムとしてマウントすることが
　可能。ただし、レイテンシ高、SMB/NFSのようなファイルロックはサポートしていない。

　ストレージにはクラスが存在する。
　Multi-Regional 世界中からアクセスするようなデータを複数のリージョンに構築
　Regional 単一リージョンで動作。GCEから頻繁にアクセスされるようなデータ
　あとは月一しか使用しないデータとか、年一しか使用しないデータとか

　ストレージクラスはバケットにオブジェクトが格納された瞬間に決まるがあとから変更もできる。
　ただし、同一バケットにMulti-RegionalとRegionalは同居できない。
　※バケット内のオブジェクトのストレージクラスを変更するには、ライフサイク管理機能を使用すると良い
　　一定時間が経過したら、Nearine,さらにたつとColdlineのように設定できる

　【アクセス制限】
　基本的にはCloud IAMで管理し、個々のオブジェクトのアクセスはACLを使用する。
　Cloud IAM プロジェクト内のバケットにアクセスできるユーザを管理
　ACL 個々のオブジェクトへのアクセス権限を管理※コンソールを使用してバケットにACLを設定することはできない。

　【バックアップ】
　Cloud Strageではバージョン管理、つまり変更履歴が管理されており、自動で作成される。
　作成されるのは変更前のオブジェクトのアーカイブファイルだが、デフォルトではこの機能はオフとなっている。
　有効にするには、gsutilなどを使用する。※Google Cloud Consoleでは変更できない。
　　gsutil versioning set on gs://バケットネーム

　アーカイブファイルも課金対象なので、前述のライフサイクル管理機能との併用が望ましい。

・Bigtable
　Apache Hase APIを通じてアクセス可能なフルマネージド型のNoSQLサービス
　数百ペタバイトまで自動スケーリングし、秒間数千万件処理が可能。
　
　大規模、低レイテンシかつ高スループットのサービスに向いている。
　SQLクエリやテーブルの結合、複数行トランザクショんはサポートされていない。

　【バックアップ】
　テーブルにデータを書き込むと３台以上のサーバに自動でレプリケートされる。
　ユーザの誤操作やアプリのバグによるデータ損失をリカバリーする論理バックアップ機能はないため
　注意。
　テーブルをHadoopシーケンスフィルとして吐き出す機能があるため、テーブルサイズ次第では、
　論理バックアップの代わりに使用することも可能。

・Datastore
　検索対象の多さにかかわらず、一定の処理時間でクエリの処理とかができる。
　これはデータセットによるスケーリングではなく、結果セットのサイズに応じて、クエリをスケールしているからだそう。
　→何のこっちゃです。

　シャーディング・・・データを複数サーバに分散させる機能
　レプリケーション・・データを複数のサーバに複製して同期させる機能
　上記が自動的に実行され、アプリの負荷にお応じてシームレスかつ自動的にスケールする。
　
　【オブジェクト指向データベース】
　
￼


JavaやPythonのようなオブジェクト指向の言語のスクリプト言語を容易に対応させることができる。

【バックアップ】
　あり、保存されたエンティティに対して、Cloud Strageにエクスポートする機能がある。

・Cloud SQL
　リレーショナルデータベースだが、現在はOracleを用いることができない。
　MySQLとPostgreSQLに対応
　
　【拡張性・耐障害性】
　Failover Replica機能
　マスターインスタンス障害時に自動でフェイルオーバーする。負荷分散を狙ったRead Repulica機能。
　注意点といて、フェイルオーバーはマスタが存在するゾーン自体が停止した場合にのみ発生するため、
　それ以外の理由でマスターが停止した場合にはフェールオーバーしない。

　【アクセス制御】
　接続ポイントはIPアドレスとなっており、適切な制御を施す必要がある。
　接続可能なIPの制限かCloud SQL Proxyのみにアクセスを許可する方法がある。
　
　【バックアップ】
　自動とオンデマンドが可能。自動は４時間の枠を準備することでその間に、バックアップが開始され
　最大で書くインスタンスの７世代までが最大でGoogle側で管理される。
　
・Spanner
　RDBとNoSQLのいいとこ取りをしたRDBサービス。
　クラウドを前提として、設計されたRDBデータベース
　特徴は大規模水平スケーリングと高い整合性
　
　
￼

　【マルチリージョンサポート】
　複数のリージョンにまたがって構成できる。
　読み取り処理は最も近いリージョンのレプリカにルーティングされる。
　書き込みはデフォルトのリーダーリージョン内のレプリカにルーティングされる。
　
　【設計上の制約】
　データベースのテーブル処理が特定のノードに集中するホットポイントを作らないように設計する必要がある。
　そのために、主キーを注意して選択する必要がある。
　逆に関連性のあるデータでまとめてアクセスされる場合には、インターリーブを用いてデータを分散配置しないように設定する。